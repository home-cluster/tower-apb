FROM ansibleplaybookbundle/apb-base:canary

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IHRvd2VyLWFwYgpkZXNjcmlwdGlvbjogQVdYIEFQQiBJbXBsZW1l\
bnRhdGlvbgpiaW5kYWJsZTogRmFsc2UKYXN5bmM6IG9wdGlvbmFsCm1ldGFkYXRhOgogIGRpc3Bs\
YXlOYW1lOiBBbnNpYmxlIFRvd2VyIChBUEIpCiAgbG9uZ0Rlc2NyaXB0aW9uOiBBbiBBUEIgdGhh\
dCBkZXBsb3lzIEFXWCAoVXBzdHJlYW0gQW5zaWJsZSBUb3dlcikKICBkb2N1bWVudGF0aW9uVXJs\
OiBodHRwczovL2RvY3MuYW5zaWJsZS5jb20vYW5zaWJsZS10b3dlci8KcGxhbnM6CiAgLSBuYW1l\
OiBhbGwtaW4tb25lCiAgICBkZXNjcmlwdGlvbjogQW4gQVBCIHRoYXQgZGVwbG95cyBBV1ggYW5k\
IHBvc3RncmVzcWwgdG9nZXRoZXIKICAgIGZyZWU6IFRydWUKICAgIG1ldGFkYXRhOgogICAgICBk\
aXNwbGF5TmFtZTogQWxsLWluLW9uZQogICAgICBsb25nRGVzY3JpcHRpb246IFRoaXMgcGxhbiBk\
ZXBsb3lzIGEgc2luZ2xlIEFXWCBpbnN0YW5jZSB3aXRoIGEgcG9zdGdyZXNxbCBiYWNrZW5kCiAg\
ICAgIGNvc3Q6ICQwLjAwCiAgICBwYXJhbWV0ZXJzOgogICAgICAtIG5hbWU6IHJlY29tbWVuZGVk\
X3Jlc291cmNlcwogICAgICAgIHRpdGxlOiBVc2UgdGhlIHJlY29tbWVuZGVkIG1pbmltdW0gcmVz\
b3VyY2UgcmVxdWlyZW1lbnRzCiAgICAgICAgZGVzY3JpcHRpb246IElmIHRydWUsIHdpbGwgcmVx\
dWlyZSBtaW5pbXVtIHJlY29tbWVuZGVkIHJlc291cmNlcyBmb3IgVG93ZXIgY29udGFpbmVycwog\
ICAgICAgIGRlZmF1bHQ6IHRydWUKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICB0eXBl\
OiBib29sCiAgICAgIC0gbmFtZTogYXd4X3Bvc3RncmVzcWxfZW1wdHlkaXIKICAgICAgICB0aXRs\
ZTogUG9zdGdyZVNRTCBFbXB0eURpcgogICAgICAgIGRlc2NyaXB0aW9uOiBVc2UgYW4gRW10cHlE\
aXIgdG8gYmFjayBQb3N0Z3JlU1FMIChub3QgcmVjb21tZW5kZWQgZm9yIHByb2R1Y3Rpb24pCiAg\
ICAgICAgZGVmYXVsdDogZmFsc2UKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICB0eXBl\
OiBib29sCiAgICAgIC0gbmFtZTogYXd4X2ltYWdlX29yZwogICAgICAgIHRpdGxlOiBBV1ggaW1h\
Z2Ugb3JnYW5pemF0aW9uCiAgICAgICAgZGVzY3JpcHRpb246IHRoZSBvcmdhbml6YXRpb24gdG8g\
cHVsbCBpbWFnZXMgZnJvbQogICAgICAgIGRlZmF1bHQ6IGFuc2libGUKICAgICAgICB0eXBlOiBz\
dHJpbmcKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgLSBuYW1lOiBhd3hfaW1hZ2VfdGFn\
CiAgICAgICAgdGl0bGU6IEFXWCBpbWFnZSB0YWcKICAgICAgICBkZXNjcmlwdGlvbjogdGhlIGlt\
YWdlIHRhZyB0byBwdWxsCiAgICAgICAgZGVmYXVsdDogbGF0ZXN0CiAgICAgICAgdHlwZTogc3Ry\
aW5nCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgIC0gbmFtZTogYXd4X3Bvc3RncmVzcWxf\
dm9sdW1lX2NhcGFjaXR5CiAgICAgICAgdGl0bGU6IFBvc3RncmVTUUwgdm9sdW1lIGNhcGFjaXR5\
CiAgICAgICAgZGVzY3JpcHRpb246IHRoZSBzaXplIG9mIHRoZSBwZXJzaXN0ZW50IHZvbHVtZSBi\
YWNraW5nIFBvc3RncmVTUUwgKGluIEdCKQogICAgICAgIGRlZmF1bHQ6IDUKICAgICAgICB0eXBl\
OiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgLSBuYW1lOiBhd3hfYWRtaW5f\
cGFzc3dvcmQKICAgICAgICB0aXRsZTogQVdYIEFkbWluIFBhc3N3b3JkCiAgICAgICAgZGVzY3Jp\
cHRpb246IFRoZSBwYXNzd29yZCBmb3IgYWRtaW4gdXNlcgogICAgICAgIGRlZmF1bHQ6IHBhc3N3\
b3JkCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCgogIC0gbmFtZTogZXh0ZXJuYWwtcGcKICAgIGRl\
c2NyaXB0aW9uOiBBV1ggd2l0aCBhbiBleHRlcm5hbCBkYXRhYmFzZQogICAgZnJlZTogVHJ1ZQog\
ICAgbWV0YWRhdGE6CiAgICAgIGRpc3BsYXlOYW1lOiBFeHRlcm5hbAogICAgICBsb25nRGVzY3Jp\
cHRpb246IFRoaXMgcGxhbiBkZXBsb3lzIGEgc2luZ2xlIEFXWCBpbnN0YW5jZSB1c2luZyBhbiBl\
eHRlcm5hbCBQb3N0Z3JlU1FMIGJhY2tlbmQKICAgICAgY29zdDogJDAuMDAKICAgIHBhcmFtZXRl\
cnM6CiAgICAgIC0gbmFtZTogcmVjb21tZW5kZWRfcmVzb3VyY2VzCiAgICAgICAgdGl0bGU6IFVz\
ZSB0aGUgcmVjb21tZW5kZWQgbWluaW11bSByZXNvdXJjZSByZXF1aXJlbWVudHMKICAgICAgICBk\
ZXNjcmlwdGlvbjogSWYgdHJ1ZSwgd2lsbCByZXF1aXJlIG1pbmltdW0gcmVjb21tZW5kZWQgcmVz\
b3VyY2VzIGZvciBUb3dlciBjb250YWluZXJzCiAgICAgICAgZGVmYXVsdDogdHJ1ZQogICAgICAg\
IHJlcXVpcmVkOiBmYWxzZQogICAgICAgIHR5cGU6IGJvb2wKICAgICAgLSBuYW1lOiBhd3hfYWRt\
aW5fcGFzc3dvcmQKICAgICAgICB0aXRsZTogQVdYIEFkbWluIFBhc3N3b3JkCiAgICAgICAgZGVz\
Y3JpcHRpb246IFRoZSBwYXNzd29yZCBmb3IgYWRtaW4gdXNlcgogICAgICAgIGRlZmF1bHQ6IHBh\
c3N3b3JkCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgIC0gbmFtZTogYXd4X2ltYWdlX29y\
ZwogICAgICAgIHRpdGxlOiBBV1ggaW1hZ2Ugb3JnYW5pemF0aW9uCiAgICAgICAgZGVzY3JpcHRp\
b246IHRoZSBvcmdhbml6YXRpb24gdG8gcHVsbCBpbWFnZXMgZnJvbQogICAgICAgIGRlZmF1bHQ6\
IGFuc2libGUKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAg\
ICAgLSBuYW1lOiBhd3hfaW1hZ2VfdGFnCiAgICAgICAgdGl0bGU6IEFXWCBpbWFnZSB0YWcKICAg\
ICAgICBkZXNjcmlwdGlvbjogdGhlIGltYWdlIHRhZyB0byBwdWxsCiAgICAgICAgZGVmYXVsdDog\
bGF0ZXN0CiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAg\
IC0gbmFtZTogYXd4X3Bvc3RncmVzcWxfaG9zdG5hbWUKICAgICAgICB0aXRsZTogUG9zdGdyZVNR\
TCBob3N0bmFtZQogICAgICAgIGRlc2NyaXB0aW9uOiB0aGUgaG9zdG5hbWUgb2YgdGhlIFBvc3Rn\
cmVTUUwgZGF0YWJhc2UKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1\
ZQogICAgICAtIG5hbWU6IGF3eF9wb3N0Z3Jlc3FsX2RibmFtZQogICAgICAgIHRpdGxlOiBQb3N0\
Z3JlU1FMIGRhdGFiYXNlIG5hbWUKICAgICAgICBkZXNjcmlwdGlvbjogdGhlIG5hbWUgb2YgdGhl\
IFBvc3RncmVTUUwgZGF0YWJhc2UKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJl\
ZDogdHJ1ZQogICAgICAtIG5hbWU6IGF3eF9wb3N0Z3Jlc3FsX3VzZXIKICAgICAgICB0aXRsZTog\
UG9zdGdyZVNRTCB1c2VyIG5hbWUKICAgICAgICBkZXNjcmlwdGlvbjogdGhlIG5hbWUgb2YgdGhl\
IFBvc3RncmVTUUwgdXNlcgogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0\
cnVlCiAgICAgIC0gbmFtZTogYXd4X3Bvc3RncmVzcWxfcGFzc3dvcmQKICAgICAgICB0aXRsZTog\
UG9zdGdyZVNRTCBwYXNzd29yZAogICAgICAgIGRlc2NyaXB0aW9uOiB0aGUgcGFzc3dvcmQgdG8g\
dGhlIFBvc3RncmVTUUwgZGF0YWJhc2UKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1\
aXJlZDogdHJ1ZQogICAgICAtIG5hbWU6IGF3eF9wb3N0Z3Jlc3FsX3BvcnQKICAgICAgICB0aXRs\
ZTogUG9zdGdyZVNRTCBwb3J0CiAgICAgICAgZGVzY3JpcHRpb246IHRoZSBwb3J0IHRoZSBQb3N0\
Z3JlU1FMIGRhdGFiYXNlIGlzIGxpc3RlbmluZyBvbgogICAgICAgIGRlZmF1bHQ6IDU0MzIKICAg\
ICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogZmFsc2UKCiAgLSBuYW1lOiBiaW5k\
LXBnCiAgICBkZXNjcmlwdGlvbjogQVdYIHdpdGggYmluZCBjcmVkZW50aWFscwogICAgZnJlZTog\
VHJ1ZQogICAgbWV0YWRhdGE6CiAgICAgIGRpc3BsYXlOYW1lOiBCaW5kCiAgICAgIGxvbmdEZXNj\
cmlwdGlvbjogVGhpcyBwbGFuIGRlcGxveXMgYSBzaW5nbGUgQVdYIGluc3RhbmNlIHVzaW5nIGJp\
bmQgY3JlZGVudGlhbHMgZnJvbSBhIHByb3Zpc2lvbmVkIFBvc3RncmVTUUwgaW5zdGFuY2UKICAg\
ICAgY29zdDogJDAuMDAKICAgIHBhcmFtZXRlcnM6CiAgICAgIC0gbmFtZTogcmVjb21tZW5kZWRf\
cmVzb3VyY2VzCiAgICAgICAgdGl0bGU6IFVzZSB0aGUgcmVjb21tZW5kZWQgbWluaW11bSByZXNv\
dXJjZSByZXF1aXJlbWVudHMKICAgICAgICBkZXNjcmlwdGlvbjogSWYgdHJ1ZSwgd2lsbCByZXF1\
aXJlIG1pbmltdW0gcmVjb21tZW5kZWQgcmVzb3VyY2VzIGZvciBUb3dlciBjb250YWluZXJzCiAg\
ICAgICAgZGVmYXVsdDogdHJ1ZQogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIHR5cGU6\
IGJvb2wKICAgICAgLSBuYW1lOiBhd3hfaW1hZ2Vfb3JnCiAgICAgICAgdGl0bGU6IEFXWCBpbWFn\
ZSBvcmdhbml6YXRpb24KICAgICAgICBkZXNjcmlwdGlvbjogdGhlIG9yZ2FuaXphdGlvbiB0byBw\
dWxsIGltYWdlcyBmcm9tCiAgICAgICAgZGVmYXVsdDogYW5zaWJsZQogICAgICAgIHR5cGU6IHN0\
cmluZwogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAtIG5hbWU6IGF3eF9pbWFnZV90YWcK\
ICAgICAgICB0aXRsZTogQVdYIGltYWdlIHRhZwogICAgICAgIGRlc2NyaXB0aW9uOiB0aGUgaW1h\
Z2UgdGFnIHRvIHB1bGwKICAgICAgICBkZWZhdWx0OiBsYXRlc3QKICAgICAgICB0eXBlOiBzdHJp\
bmcKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgLSBuYW1lOiBhd3hfYWRtaW5fcGFzc3dv\
cmQKICAgICAgICB0aXRsZTogQVdYIEFkbWluIFBhc3N3b3JkCiAgICAgICAgZGVzY3JpcHRpb246\
IFRoZSBwYXNzd29yZCBmb3IgYWRtaW4gdXNlcgogICAgICAgIGRlZmF1bHQ6IHBhc3N3b3JkCiAg\
ICAgICAgcmVxdWlyZWQ6IGZhbHNlCg=="

RUN curl -L https://github.com/ansible/awx/archive/devel.tar.gz -o /tmp/awx.tar.gz \
  && mkdir -p /usr/share/awx_installer \
  && tar --strip-components=1 -xvf /tmp/awx.tar.gz -C /usr/share/awx_installer \
  && rm -f /tmp/awx.tar.gz

RUN cp /usr/share/awx_installer/installer/inventory /etc/ansible/hosts

ADD playbooks /opt/apb/actions
ADD . /opt/ansible/roles/tower-apb
ADD vars /var/awx/
ADD ansible.cfg /etc/ansible/ansible.cfg

RUN chmod -R g=u /opt/{ansible,apb}

USER apb
