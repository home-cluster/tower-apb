FROM ansibleplaybookbundle/apb-base:canary

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IHRvd2VyLWFwYgpkZXNjcmlwdGlvbjogQVdYIEFQQiBJbXBsZW1l\
bnRhdGlvbgpiaW5kYWJsZTogRmFsc2UKYXN5bmM6IG9wdGlvbmFsCm1ldGFkYXRhOgogIGRpc3Bs\
YXlOYW1lOiBBbnNpYmxlIFRvd2VyIChBUEIpCiAgbG9uZ0Rlc2NyaXB0aW9uOiBBbiBBUEIgdGhh\
dCBkZXBsb3lzIEFXWCAoVXBzdHJlYW0gQW5zaWJsZSBUb3dlcikKICBkb2N1bWVudGF0aW9uVXJs\
OiBodHRwczovL2RvY3MuYW5zaWJsZS5jb20vYW5zaWJsZS10b3dlci8KcGxhbnM6CiAgLSBuYW1l\
OiBhbGwtaW4tb25lCiAgICBkZXNjcmlwdGlvbjogQW4gQVBCIHRoYXQgZGVwbG95cyBBV1ggYW5k\
IHBvc3RncmVzcWwgdG9nZXRoZXIKICAgIGZyZWU6IFRydWUKICAgIG1ldGFkYXRhOgogICAgICBk\
aXNwbGF5TmFtZTogQWxsLWluLW9uZQogICAgICBsb25nRGVzY3JpcHRpb246IFRoaXMgcGxhbiBk\
ZXBsb3lzIGEgc2luZ2xlIEFXWCBpbnN0YW5jZSB3aXRoIGEgcG9zdGdyZXNxbCBiYWNrZW5kCiAg\
ICAgIGNvc3Q6ICQwLjAwCiAgICBwYXJhbWV0ZXJzOgogICAgICAtIG5hbWU6IHNraXBfdGxzX3Zl\
cmlmeQogICAgICAgIHRpdGxlOiBTa2lwIE9wZW5TaGlmdCBUTFMgdmVyaWZ5CiAgICAgICAgZGVz\
Y3JpcHRpb246IElmIHRydWUsIHdpbGwgbm90IFRMUyB2ZXJpZnkgd2hlbiBtYWtpbmcgQVBJIHJl\
cXVlc3RzCiAgICAgICAgZGVmYXVsdDogZmFsc2UKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAg\
ICAgICB0eXBlOiBib29sCiAgICAgIC0gbmFtZTogcmVjb21tZW5kZWRfcmVzb3VyY2VzCiAgICAg\
ICAgdGl0bGU6IFVzZSB0aGUgcmVjb21tZW5kZWQgbWluaW11bSByZXNvdXJjZSByZXF1aXJlbWVu\
dHMKICAgICAgICBkZXNjcmlwdGlvbjogSWYgdHJ1ZSwgd2lsbCByZXF1aXJlIG1pbmltdW0gcmVj\
b21tZW5kZWQgcmVzb3VyY2VzIGZvciBUb3dlciBjb250YWluZXJzCiAgICAgICAgZGVmYXVsdDog\
dHJ1ZQogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgdHlwZTogYm9vbAogICAgICAtIG5h\
bWU6IHBvc3RncmVzcWxfZW1wdHlkaXIKICAgICAgICB0aXRsZTogUG9zdGdyZVNRTCBFbXB0eURp\
cgogICAgICAgIGRlc2NyaXB0aW9uOiBVc2UgYW4gRW10cHlEaXIgdG8gYmFjayBQb3N0Z3JlU1FM\
IChub3QgcmVjb21tZW5kZWQgZm9yIHByb2R1Y3Rpb24pCiAgICAgICAgZGVmYXVsdDogZmFsc2UK\
ICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICB0eXBlOiBib29sCiAgICAgIC0gbmFtZTog\
YXd4X2ltYWdlX29yZwogICAgICAgIHRpdGxlOiBBV1ggaW1hZ2Ugb3JnYW5pemF0aW9uCiAgICAg\
ICAgZGVzY3JpcHRpb246IHRoZSBvcmdhbml6YXRpb24gdG8gcHVsbCBpbWFnZXMgZnJvbQogICAg\
ICAgIGRlZmF1bHQ6IGFuc2libGUKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJl\
ZDogZmFsc2UKICAgICAgLSBuYW1lOiBhd3hfaW1hZ2VfdGFnCiAgICAgICAgdGl0bGU6IEFXWCBp\
bWFnZSB0YWcKICAgICAgICBkZXNjcmlwdGlvbjogdGhlIGltYWdlIHRhZyB0byBwdWxsCiAgICAg\
ICAgZGVmYXVsdDogbGF0ZXN0CiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6\
IGZhbHNlCiAgICAgIC0gbmFtZTogYXd4X3Bvc3RncmVzcWxfdm9sdW1lX2NhcGFjaXR5CiAgICAg\
ICAgdGl0bGU6IFBvc3RncmVTUUwgdm9sdW1lIGNhcGFjaXR5CiAgICAgICAgZGVzY3JpcHRpb246\
IHRoZSBzaXplIG9mIHRoZSBwZXJzaXN0ZW50IHZvbHVtZSBiYWNraW5nIFBvc3RncmVTUUwgKGlu\
IEdCKQogICAgICAgIGRlZmF1bHQ6IDUKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1\
aXJlZDogZmFsc2UKCiAgLSBuYW1lOiBleHRlcm5hbC1wZwogICAgZGVzY3JpcHRpb246IEFXWCB3\
aXRoIGFuIGV4dGVybmFsIGRhdGFiYXNlCiAgICBmcmVlOiBUcnVlCiAgICBtZXRhZGF0YToKICAg\
ICAgZGlzcGxheU5hbWU6IEV4dGVybmFsCiAgICAgIGxvbmdEZXNjcmlwdGlvbjogVGhpcyBwbGFu\
IGRlcGxveXMgYSBzaW5nbGUgQVdYIGluc3RhbmNlIHVzaW5nIGFuIGV4dGVybmFsIFBvc3RncmVT\
UUwgYmFja2VuZAogICAgICBjb3N0OiAkMC4wMAogICAgcGFyYW1ldGVyczoKICAgICAgLSBuYW1l\
OiByZWNvbW1lbmRlZF9yZXNvdXJjZXMKICAgICAgICB0aXRsZTogVXNlIHRoZSByZWNvbW1lbmRl\
ZCBtaW5pbXVtIHJlc291cmNlIHJlcXVpcmVtZW50cwogICAgICAgIGRlc2NyaXB0aW9uOiBJZiB0\
cnVlLCB3aWxsIHJlcXVpcmUgbWluaW11bSByZWNvbW1lbmRlZCByZXNvdXJjZXMgZm9yIFRvd2Vy\
IGNvbnRhaW5lcnMKICAgICAgICBkZWZhdWx0OiB0cnVlCiAgICAgICAgcmVxdWlyZWQ6IHRydWUK\
ICAgICAgICB0eXBlOiBib29sCiAgICAgIC0gbmFtZTogYWRtaW5fYXBpX3Rva2VuCiAgICAgICAg\
dGl0bGU6IEFkbWluIEFQSSBUb2tlbgogICAgICAgIGRlc2NyaXB0aW9uOiBBbiBPcGVuU2hpZnQg\
QVBJIFRva2VuIHdpdGggYWRtaW4tbGV2ZWwgcGVybWlzc2lvbnMuCiAgICAgICAgcmVxdWlyZWQ6\
IGZhbHNlCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgIC0gbmFtZTogc2tpcF90bHNfdmVyaWZ5\
CiAgICAgICAgdGl0bGU6IFNraXAgT3BlblNoaWZ0IFRMUyB2ZXJpZnkKICAgICAgICBkZXNjcmlw\
dGlvbjogSWYgdHJ1ZSwgd2lsbCBub3QgVExTIHZlcmlmeSB3aGVuIG1ha2luZyBBUEkgcmVxdWVz\
dHMKICAgICAgICBkZWZhdWx0OiBmYWxzZQogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAg\
IHR5cGU6IGJvb2wKICAgICAgLSBuYW1lOiBhd3hfYWRtaW5fcGFzc3dvcmQKICAgICAgICB0aXRs\
ZTogQVdYIEFkbWluIFBhc3N3b3JkCiAgICAgICAgZGVzY3JpcHRpb246IFRoZSBwYXNzd29yZCBm\
b3IgYWRtaW4gdXNlcgogICAgICAgIGRlZmF1bHQ6IHBhc3N3b3JkCiAgICAgICAgcmVxdWlyZWQ6\
IGZhbHNlCiAgICAgIC0gbmFtZTogYXd4X2ltYWdlX29yZwogICAgICAgIHRpdGxlOiBBV1ggaW1h\
Z2Ugb3JnYW5pemF0aW9uCiAgICAgICAgZGVzY3JpcHRpb246IHRoZSBvcmdhbml6YXRpb24gdG8g\
cHVsbCBpbWFnZXMgZnJvbQogICAgICAgIGRlZmF1bHQ6IGFuc2libGUKICAgICAgICB0eXBlOiBz\
dHJpbmcKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgLSBuYW1lOiBhd3hfaW1hZ2VfdGFn\
CiAgICAgICAgdGl0bGU6IEFXWCBpbWFnZSB0YWcKICAgICAgICBkZXNjcmlwdGlvbjogdGhlIGlt\
YWdlIHRhZyB0byBwdWxsCiAgICAgICAgZGVmYXVsdDogbGF0ZXN0CiAgICAgICAgdHlwZTogc3Ry\
aW5nCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgIC0gbmFtZTogYXd4X3Bvc3RncmVzcWxf\
aG9zdG5hbWUKICAgICAgICB0aXRsZTogUG9zdGdyZVNRTCBob3N0bmFtZQogICAgICAgIGRlc2Ny\
aXB0aW9uOiB0aGUgaG9zdG5hbWUgb2YgdGhlIFBvc3RncmVTUUwgZGF0YWJhc2UKICAgICAgICB0\
eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIG5hbWU6IGF3eF9wb3N0\
Z3Jlc3FsX2RibmFtZQogICAgICAgIHRpdGxlOiBQb3N0Z3JlU1FMIGRhdGFiYXNlIG5hbWUKICAg\
ICAgICBkZXNjcmlwdGlvbjogdGhlIG5hbWUgb2YgdGhlIFBvc3RncmVTUUwgZGF0YWJhc2UKICAg\
ICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIG5hbWU6IGF3\
eF9wb3N0Z3Jlc3FsX3VzZXIKICAgICAgICB0aXRsZTogUG9zdGdyZVNRTCB1c2VyIG5hbWUKICAg\
ICAgICBkZXNjcmlwdGlvbjogdGhlIG5hbWUgb2YgdGhlIFBvc3RncmVTUUwgdXNlcgogICAgICAg\
IHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIC0gbmFtZTogYXd4X3Bv\
c3RncmVzcWxfcGFzc3dvcmQKICAgICAgICB0aXRsZTogUG9zdGdyZVNRTCBwYXNzd29yZAogICAg\
ICAgIGRlc2NyaXB0aW9uOiB0aGUgcGFzc3dvcmQgdG8gdGhlIFBvc3RncmVTUUwgZGF0YWJhc2UK\
ICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIG5hbWU6\
IGF3eF9wb3N0Z3Jlc3FsX3BvcnQKICAgICAgICB0aXRsZTogUG9zdGdyZVNRTCBwb3J0CiAgICAg\
ICAgZGVzY3JpcHRpb246IHRoZSBwb3J0IHRoZSBQb3N0Z3JlU1FMIGRhdGFiYXNlIGlzIGxpc3Rl\
bmluZyBvbgogICAgICAgIGRlZmF1bHQ6IDU0MzIKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAg\
ICByZXF1aXJlZDogZmFsc2UKCiAgLSBuYW1lOiBiaW5kLXBnCiAgICBkZXNjcmlwdGlvbjogQVdY\
IHdpdGggYmluZCBjcmVkZW50aWFscwogICAgZnJlZTogVHJ1ZQogICAgbWV0YWRhdGE6CiAgICAg\
IGRpc3BsYXlOYW1lOiBCaW5kCiAgICAgIGxvbmdEZXNjcmlwdGlvbjogVGhpcyBwbGFuIGRlcGxv\
eXMgYSBzaW5nbGUgQVdYIGluc3RhbmNlIHVzaW5nIGJpbmQgY3JlZGVudGlhbHMgZnJvbSBhIHBy\
b3Zpc2lvbmVkIFBvc3RncmVTUUwgaW5zdGFuY2UKICAgICAgY29zdDogJDAuMDAKICAgIHBhcmFt\
ZXRlcnM6CiAgICAgIC0gbmFtZTogcmVjb21tZW5kZWRfcmVzb3VyY2VzCiAgICAgICAgdGl0bGU6\
IFVzZSB0aGUgcmVjb21tZW5kZWQgbWluaW11bSByZXNvdXJjZSByZXF1aXJlbWVudHMKICAgICAg\
ICBkZXNjcmlwdGlvbjogSWYgdHJ1ZSwgd2lsbCByZXF1aXJlIG1pbmltdW0gcmVjb21tZW5kZWQg\
cmVzb3VyY2VzIGZvciBUb3dlciBjb250YWluZXJzCiAgICAgICAgZGVmYXVsdDogdHJ1ZQogICAg\
ICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgdHlwZTogYm9vbAogICAgICAtIG5hbWU6IHNraXBf\
dGxzX3ZlcmlmeQogICAgICAgIHRpdGxlOiBTa2lwIE9wZW5TaGlmdCBUTFMgdmVyaWZ5CiAgICAg\
ICAgZGVzY3JpcHRpb246IHNraXAgVExTIHZlcmlmeSB3aGVuIG1ha2luZyBPcGVuU2hpZnQgQVBJ\
IHJlcXVlc3RzCiAgICAgICAgZGVmYXVsdDogZmFsc2UKICAgICAgICByZXF1aXJlZDogZmFsc2UK\
ICAgICAgICB0eXBlOiBib29sCiAgICAgIC0gbmFtZTogYXd4X2ltYWdlX29yZwogICAgICAgIHRp\
dGxlOiBBV1ggaW1hZ2Ugb3JnYW5pemF0aW9uCiAgICAgICAgZGVzY3JpcHRpb246IHRoZSBvcmdh\
bml6YXRpb24gdG8gcHVsbCBpbWFnZXMgZnJvbQogICAgICAgIGRlZmF1bHQ6IGFuc2libGUKICAg\
ICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgLSBuYW1lOiBh\
d3hfaW1hZ2VfdGFnCiAgICAgICAgdGl0bGU6IEFXWCBpbWFnZSB0YWcKICAgICAgICBkZXNjcmlw\
dGlvbjogdGhlIGltYWdlIHRhZyB0byBwdWxsCiAgICAgICAgZGVmYXVsdDogbGF0ZXN0CiAgICAg\
ICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCgo="

RUN curl -L https://github.com/ansible/awx/archive/devel.tar.gz -o /tmp/awx.tar.gz \
  && mkdir -p /usr/share/awx_installer \
  && tar --strip-components=1 -xvf /tmp/awx.tar.gz -C /usr/share/awx_installer \
  && rm -f /tmp/awx.tar.gz

RUN cp /usr/share/awx_installer/installer/inventory /etc/ansible/hosts

ADD playbooks /opt/apb/actions
ADD . /opt/ansible/roles/tower-apb

RUN chmod -R g=u /opt/{ansible,apb}

USER apb
